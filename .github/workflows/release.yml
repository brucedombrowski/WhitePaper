name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install TeX Live, pandoc, and Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-recommended texlive-latex-extra \
            texlive-fonts-recommended texlive-bibtex-extra biber pandoc poppler-utils

      - name: Build PDF and HTML
        run: |
          # generate_metrics.py needs git repos locally â€” in CI we use committed metrics.tex
          # (build.sh will skip metrics generation gracefully if repos are absent)
          ./build.sh

      - name: Get version info
        id: meta
        run: |
          PAGES=$(pdfinfo whitepaper.pdf | grep "Pages:" | awk '{print $2}')
          SIZE=$(ls -lh whitepaper.pdf | awk '{print $5}')
          echo "pages=$PAGES" >> "$GITHUB_OUTPUT"
          echo "size=$SIZE" >> "$GITHUB_OUTPUT"

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ github.ref_name }}" \
            whitepaper.pdf \
            whitepaper-review.html \
            --clobber
